<!doctype html>
<html>
<head>
    <title>Gallery</title>
    <style>
        body {
            display: flex;
            flex-direction: row;
            margin: 0;
            font-family: sans-serif;
        }
        .main-content {
            flex: 1;
            padding: 20px;
        }
        .sidebar {
            width: 250px;
            background-color: #f8f8f8;
            padding: 20px;
            border-left: 1px solid #ccc;
        }
        .sidebar h3 {
            margin-top: 0;
        }
        .tag-list {
            list-style: none;
            padding: 0;
        }
        .tag-list li {
            margin: 5px 0;
        }
        .tag-list a {
            text-decoration: none;
            color: #2196F3;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .gallery-item {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        .gallery-item img, .gallery-item video {
            max-width: 100%;
            height: auto;
            cursor: pointer;
        }
        .action-buttons {
            margin-top: 10px;
        }
        .tags {
            margin-top: 8px;
            font-size: 0.9em;
        }
        .tag {
            display: inline-block;
            background-color: #e0e0e0;
            border-radius: 4px;
            padding: 2px 6px;
            margin: 2px;
        }
        .rename-tag-form input {
            width: 80px;
            font-size: 0.8em;
        }
        .rename-tag-form button {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>Photo Gallery</h1>
        <form action="{{ url_for('main.search') }}" method="GET">
            <input type="text" name="query" placeholder="Search tags, descriptions, filenames..." style="width: 60%;">
            <button type="submit">üîç Search</button>
        </form>

        <a href="{{ url_for('main.upload') }}">Upload New Photo</a>

        {% if request.args.get('tag') %}
        <div style="margin-top: 10px;">
            <strong>Filtering by tag:</strong> "{{ request.args.get('tag') }}"<br>
            <a href="{{ url_for('main.index') }}">üîÑ Clear Filter</a>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}
        {% endwith %}

        <h3>Rename Tag Across All Images</h3>
        <form action="{{ url_for('main.rename_tag_global') }}" method="POST">
            <input type="text" name="old_tag" placeholder="Old tag" required>
            <input type="text" name="new_tag" placeholder="New tag" required>
            <button type="submit">Rename Globally</button>
        </form>

        <div class="gallery-grid">
            {% for image in images %}
            <div class="gallery-item">
                {% if image.type == 'video' %}
                    <img src="{{ url_for('static', filename=image.thumb) }}"
                         alt="{{ image.filename }}"
                         onclick="openPreview('{{ url_for('static', filename='uploads/' + image.filename) }}', true)">
                {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                         alt="{{ image.filename }}"
                         onclick="openPreview(this.src)">
                {% endif %}

                {% if image.album %}
                    <p>üìÅ Album: {{ image.album }}</p>
                {% endif %}

                <form action="{{ url_for('main.update_description', filename=image.filename) }}" method="POST">
                    <textarea name="description" rows="2" cols="25">{{ image.description }}</textarea><br>
                    <button type="submit">üíæ Save</button>
                </form>

                <div class="tags">
                    {% if image.tags %}
                        <strong>Tags:</strong><br>
                        {% for tag in image.tags %}
                            <a href="{{ url_for('main.index', tag=tag|lower) }}" class="tag">üìå {{ tag }}</a>
                            <form action="{{ url_for('main.remove_tag', filename=image.filename, tag=tag) }}" method="POST" style="display:inline;">
                                <button type="submit">‚ùå</button>
                            </form>
                            <form class="rename-tag-form" action="{{ url_for('main.rename_tag_single') }}" method="POST" style="display:inline;">
                                <input type="hidden" name="filename" value="{{ image.filename }}">
                                <input type="hidden" name="old_tag" value="{{ tag }}">
                                <input type="text" name="new_tag" placeholder="Rename" maxlength="30">
                                <button type="submit">‚úèÔ∏è</button>
                            </form>
                            <br>
                        {% endfor %}
                    {% endif %}
                    <form action="{{ url_for('main.add_tag', filename=image.filename) }}" method="POST" style="margin-top: 5px;">
                        <input type="text" name="tag" placeholder="Add tag..." maxlength="30">
                        <button type="submit">‚ûï</button>
                    </form>
                </div>

                <div class="action-buttons">
                    <a href="{{ url_for('main.download_image', filename=image.filename) }}">
                        <button>‚¨áÔ∏è Download</button>
                    </a>
                    <form action="{{ url_for('main.delete_image', filename=image.filename) }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete this image?');">
                        <button type="submit">üóëÔ∏è Delete</button>
                    </form>
                </div>
            </div>
            {% else %}
            <p>No photos yet. Be the first to upload one!</p>
            {% endfor %}
        </div>
    </div>

    <div class="sidebar">
        <h3>Tags</h3>
        <ul class="tag-list">
            {% for tag in sorted(tags.values() | sum(start=[])) | unique %}
                <li><a href="{{ url_for('main.index', tag=tag|lower) }}">{{ tag }}</a></li>
            {% endfor %}
        </ul>
    </div>

    <script>
        function openPreview(src, isVideo = false) {
            const preview = document.createElement('div');
            preview.id = "preview";
            preview.style.position = "fixed";
            preview.style.top = "0";
            preview.style.left = "0";
            preview.style.width = "100%";
            preview.style.height = "100%";
            preview.style.backgroundColor = "rgba(0,0,0,0.8)";
            preview.style.zIndex = "9999";
            preview.style.display = "flex";
            preview.style.justifyContent = "center";
            preview.style.alignItems = "center";

            const content = isVideo ? document.createElement("video") : document.createElement("img");
            content.src = src;
            if (isVideo) {
                content.controls = true;
                content.autoplay = true;
            }
            content.style.maxWidth = "90vw";
            content.style.maxHeight = "90vh";
            preview.appendChild(content);
            preview.onclick = () => document.body.removeChild(preview);
            document.body.appendChild(preview);
        }
    </script>
</body>
</html>

